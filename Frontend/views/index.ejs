<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Miniproject</title>
  <%- include('menu.html') %>

    <!-- Hero Section -->
    <main class="main">
      <section id="hero" class="hero section dark-background">
        <img src="public/assets/img/hero-bg.jpg" alt="" data-aos="fade-in">

        <!-- <div class="container text-center" data-aos="fade-up" data-aos-delay="100"> -->
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <h2>Welcome to Our Lumia</h2>
            <p>We are team of talented designers making websites with Bootstrap</p>
            <a href="#about" class="btn-get-started">Get Started</a>
          </div>
          <!-- </div> -->
        </div>
    </main>
    </section><!-- /Hero Section -->
    <section class="container my-5">
      <% if(typeof user !='undefined' && user.nickname) { %>
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body text-center">
                <h3 class="card-title">ë°˜ê°‘ìŠµë‹ˆë‹¤. <%= user.nickname %>ë‹˜.</h3>
                <% if(typeof data !='undefined' && data.passwordChangeRequired) { %>
                  <div class="alert alert-warning mb-4" role="alert">
                    ë³´ì•ˆì„ ìœ„í•´ ì •ê¸°ì ì¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                    ì§€ê¸ˆ ë°”ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                  </div>
                  <% } %>
                    <a href="/auth/logout" class="btn btn-danger btn-block">ë¡œê·¸ì•„ì›ƒ</a>
              </div>
            </div>
          </div>
        </div>
        <% } else { %>
          <div class="row justify-content-center">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body text-center">
                  <h3 class="card-title">Miniproject</h3>

                  <p></p>
                  <!-- ë„¤ì•„ë¡œ ë²„íŠ¼ -->

                </div>
              </div>
            </div>
          </div>
          <% } %>
    </section>

    <!-- <div class="chat-button" id="chat-button">
    ğŸ’¬
  </div>

  <div class="chat-window" id="chat-window">
    <div class="chat-header">
      ì€í–‰ ë„ìš°ë¯¸ë´‡
    </div>
    <div class="chat-body" id="chat-messages">
      <div class="bot-message"><strong>ë„ìš°ë¯¸ë´‡: </strong><span>ì•ˆë…•í•˜ì„¸ìš”.<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</span></div>
    </div>
    <div class="chat-footer">
      <input type="text" id="chat-input" class="form-control" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onkeydown="handleKeydown(event)">
      <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
    </div>
  </div> -->

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      function handleKeydown(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      $(document).ready(function () {
        $('#chat-button').click(function () {
          $('#chat-window').toggle();
        });
      });

      async function sendMessage() {
        const inputElement = document.getElementById('chat-input');
        const message = inputElement.value.trim();
        if (message === "") return;

        // ê³ ê°ë‹˜ì˜ ë©”ì‹œì§€ë¥¼ ì±„íŒ… ì°½ì— ì¶”ê°€
        addMessageToChat('ê³ ê°ë‹˜', message);
        inputElement.value = "";

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const botName = 'ë„ìš°ë¯¸ë´‡';

        // ì„œë²„ë¡œ ì§ˆë¬¸ ì „ì†¡
        try {
          const response = await fetch('/chatbot', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ question: message })
          });

          const { data } = await response.json();
          if (response.ok || data.answer) {
            addMessageToChat(botName, data.answer);
          } else {
            addMessageToChat(botName, "ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ì£„ì†¡í•©ë‹ˆë‹¤.");
          }
        } catch (error) {
          addMessageToChat(botName, "ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ì£„ì†¡í•©ë‹ˆë‹¤.");
        }
      }

      function addMessageToChat(sender, message) {
        const chatMessagesElement = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        const senderElement = document.createElement('strong');
        const messageTextElement = document.createElement('span');

        senderElement.textContent = `${sender}: `;
        messageTextElement.innerHTML = message;

        if (sender === 'ê³ ê°ë‹˜') {
          messageElement.className = 'user-message';
        } else {
          messageElement.className = 'bot-message';
        }

        messageElement.appendChild(senderElement);
        messageElement.appendChild(messageTextElement);
        chatMessagesElement.appendChild(messageElement);
        chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
      }
    </script>

    <% if (typeof data !='undefined' && data.alertMsg) { %>
      <script>alert('<%= data.alertMsg %>');</script>
      <% } %>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
        </body>

        <% if(typeof api_url !='undefined' ) { %>
          <script>
            document.getElementById('naver-login-btn').addEventListener('click', function (event) {
              document.getElementById('naver-login-btn').href = '<%= api_url %>';
            });
          </script>
          <% } %>

            </body>

</html>